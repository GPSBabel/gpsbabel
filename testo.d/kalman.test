rm -f ${TMPDIR}/kalman_out.gpx
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_in.gpx -x kalman -o gpx -F ${TMPDIR}/kalman_in_filtered.gpx -o gpx -F ${TMPDIR}/kalman_out_filtered.gpx > ${TMPDIR}/kalman_default.log 2>&1
compare  ${REFERENCE}/track/kalman_out.gpx ${TMPDIR}/kalman_out_filtered.gpx
cat ${TMPDIR}/kalman_default.log

# Test for kalman_seen_track.gpx
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_seen_track.gpx -x kalman,gap_factor=5.0 -o gpx -F ${TMPDIR}/kalman_seen_track_filtered.gpx > ${TMPDIR}/kalman_seen_track.log 2>&1
compare ${REFERENCE}/track/kalman_seen_track_out.gpx ${TMPDIR}/kalman_seen_track_filtered.gpx
cat ${TMPDIR}/kalman_seen_track.log

# Test for kalman_seen_track.gpx with gap_factor=10.0
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_seen_track.gpx -x kalman,gap_factor=10.0 -o gpx -F ${TMPDIR}/kalman_seen_track_gap10_filtered.gpx > ${TMPDIR}/kalman_seen_track_gap10.log 2>&1
compare ${REFERENCE}/track/kalman_seen_track_gap10_out.gpx ${TMPDIR}/kalman_seen_track_gap10_filtered.gpx
cat ${TMPDIR}/kalman_seen_track_gap10.log

# Test for NVector and Vector3D utility methods
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_nvector_test_in.gpx -x kalman -o gpx -F ${TMPDIR}/kalman_nvector_test_out.gpx > ${TMPDIR}/kalman_nvector.log 2>&1
compare ${REFERENCE}/track/kalman_nvector_test_out.gpx ${TMPDIR}/kalman_nvector_test_out.gpx
cat ${TMPDIR}/kalman_nvector.log

# Test for PreFilterState transitions and edge cases
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_prefilter_edge_in.gpx -x kalman -o gpx -F ${TMPDIR}/kalman_prefilter_edge_filtered.gpx > ${TMPDIR}/kalman_prefilter_edge.log 2>&1
compare ${REFERENCE}/track/kalman_prefilter_edge_out.gpx ${TMPDIR}/kalman_prefilter_edge_filtered.gpx
cat ${TMPDIR}/kalman_prefilter_edge.log

# Test for configurable parameters (profile=auto)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_hyper_realistic_in.gpx -x track,name="Driving Track" -x kalman,profile=auto -o gpx -F ${TMPDIR}/kalman_hyper_realistic_auto_out.gpx > ${TMPDIR}/kalman_auto.log 2>&1
compare ${REFERENCE}/track/kalman_hyper_realistic_auto_out.gpx ${TMPDIR}/kalman_hyper_realistic_auto_out.gpx
cat ${TMPDIR}/kalman_auto.log

# Test for configurable parameters (profile=walking)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_hyper_realistic_in.gpx -x track,name="Walking Track" -x kalman,profile=walking -o gpx -F ${TMPDIR}/kalman_hyper_realistic_walking_out.gpx > ${TMPDIR}/kalman_walking.log 2>&1
compare ${REFERENCE}/track/kalman_hyper_realistic_walking_out.gpx ${TMPDIR}/kalman_hyper_realistic_walking_out.gpx
cat ${TMPDIR}/kalman_walking.log

# Test for 'running' profile
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_hyper_realistic_in.gpx -x track,name="Running Track" -x kalman,profile=running -o gpx -F ${TMPDIR}/kalman_hyper_realistic_running_out.gpx > ${TMPDIR}/kalman_running.log 2>&1
compare ${REFERENCE}/track/kalman_hyper_realistic_running_out.gpx ${TMPDIR}/kalman_hyper_realistic_running_out.gpx
cat ${TMPDIR}/kalman_running.log

# Test for configurable parameters (profile=cycling)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_hyper_realistic_in.gpx -x track,name="Cycling Track" -x kalman,profile=cycling -o gpx -F ${TMPDIR}/kalman_hyper_realistic_cycling_out.gpx > ${TMPDIR}/kalman_cycling.log 2>&1
compare ${REFERENCE}/track/kalman_hyper_realistic_cycling_out.gpx ${TMPDIR}/kalman_hyper_realistic_cycling_out.gpx
cat ${TMPDIR}/kalman_cycling.log

# Test for configurable parameters (profile=driving)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_hyper_realistic_in.gpx -x track,name="Driving Track" -x kalman,profile=driving -o gpx -F ${TMPDIR}/kalman_hyper_realistic_driving_out.gpx > ${TMPDIR}/kalman_driving.log 2>&1
compare ${REFERENCE}/track/kalman_hyper_realistic_driving_out.gpx ${TMPDIR}/kalman_hyper_realistic_driving_out.gpx
cat ${TMPDIR}/kalman_driving.log

# Test for configurable parameters (profile=flying)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_hyper_realistic_in.gpx -x track,name="Flying Track" -x kalman,profile=flying -o gpx -F ${TMPDIR}/kalman_hyper_realistic_flying_out.gpx > ${TMPDIR}/kalman_flying.log 2>&1
compare ${REFERENCE}/track/kalman_hyper_realistic_flying_out.gpx ${TMPDIR}/kalman_hyper_realistic_flying_out.gpx
cat ${TMPDIR}/kalman_flying.log

# Test for interpolation with interp_min_multiplier override
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_interpolation_in.gpx -x kalman,profile=cycling,interp_min_multiplier=1.0 -o gpx -F ${TMPDIR}/kalman_interp_min_multiplier_override_filtered.gpx > ${TMPDIR}/kalman_interp_min_multiplier_override.log 2>&1
compare ${REFERENCE}/track/kalman_interp_min_multiplier_override_out.gpx ${TMPDIR}/kalman_interp_min_multiplier_override_filtered.gpx
cat ${TMPDIR}/kalman_interp_min_multiplier_override.log

# Test for max_speed override with cycling profile
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_hyper_realistic_in.gpx -x track,name="Cycling Track" -x kalman,profile=cycling,max_speed=20.0 -o gpx -F ${TMPDIR}/kalman_cycling_maxspeed_override_filtered.gpx > ${TMPDIR}/kalman_cycling_maxspeed_override.log 2>&1
compare ${REFERENCE}/track/kalman_cycling_maxspeed_override_out.gpx ${TMPDIR}/kalman_cycling_maxspeed_override_filtered.gpx
cat ${TMPDIR}/kalman_cycling_maxspeed_override.log

# Test for complex zinger sequences and state transitions
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_complex_zinger_in.gpx -x kalman,profile=walking -o gpx -F ${TMPDIR}/kalman_complex_zinger_filtered.gpx > ${TMPDIR}/kalman_complex_zinger.log 2>&1
compare ${REFERENCE}/track/kalman_complex_zinger_out.gpx ${TMPDIR}/kalman_complex_zinger_filtered.gpx
cat ${TMPDIR}/kalman_complex_zinger.log

# Test for dt=0 handling
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_dt_zero_in.gpx -x kalman -o gpx -F ${TMPDIR}/kalman_dt_zero_filtered.gpx > ${TMPDIR}/kalman_dt_zero.log 2>&1
compare ${REFERENCE}/track/kalman_dt_zero_out.gpx ${TMPDIR}/kalman_dt_zero_filtered.gpx
cat ${TMPDIR}/kalman_dt_zero.log

# tests for q_scale_pos and r_scale sensitivity
# Base case (cycling profile defaults)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_q_scale_test_in.gpx -x kalman,profile=cycling -o gpx -F ${TMPDIR}/kalman_q_scale_base_filtered.gpx > ${TMPDIR}/kalman_q_scale_base.log 2>&1
compare ${REFERENCE}/track/kalman_q_scale_base_out.gpx ${TMPDIR}/kalman_q_scale_base_filtered.gpx
cat ${TMPDIR}/kalman_q_scale_base.log

# Low q_scale_pos (more smoothing)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_q_scale_test_in.gpx -x kalman,profile=cycling,q_scale_pos=0.1 -o gpx -F ${TMPDIR}/kalman_q_scale_pos_low_filtered.gpx > ${TMPDIR}/kalman_q_scale_pos_low.log 2>&1
compare ${REFERENCE}/track/kalman_q_scale_pos_low_out.gpx ${TMPDIR}/kalman_q_scale_pos_low_filtered.gpx
cat ${TMPDIR}/kalman_q_scale_pos_low.log

# High q_scale_pos (less smoothing, follows measurements more)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_q_scale_test_in.gpx -x kalman,profile=cycling,q_scale_pos=10.0 -o gpx -F ${TMPDIR}/kalman_q_scale_pos_high_filtered.gpx > ${TMPDIR}/kalman_q_scale_pos_high.log 2>&1
compare ${REFERENCE}/track/kalman_q_scale_pos_high_out.gpx ${TMPDIR}/kalman_q_scale_pos_high_filtered.gpx
cat ${TMPDIR}/kalman_q_scale_pos_high.log

# Low r_scale (trusts measurements more)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_q_scale_test_in.gpx -x kalman,profile=cycling,r_scale=0.1 -o gpx -F ${TMPDIR}/kalman_r_scale_low_filtered.gpx > ${TMPDIR}/kalman_r_scale_low.log 2>&1
compare ${REFERENCE}/track/kalman_r_scale_low_out.gpx ${TMPDIR}/kalman_r_scale_low_filtered.gpx
cat ${TMPDIR}/kalman_r_scale_low.log

# High r_scale (trusts measurements less, more smoothing)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_q_scale_test_in.gpx -x kalman,profile=cycling,r_scale=10.0 -o gpx -F ${TMPDIR}/kalman_r_scale_high_filtered.gpx > ${TMPDIR}/kalman_r_scale_high.log 2>&1
compare ${REFERENCE}/track/kalman_r_scale_high_out.gpx ${TMPDIR}/kalman_r_scale_high_filtered.gpx
cat ${TMPDIR}/kalman_r_scale_high.log

# Low q_scale_vel (more velocity smoothing)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_q_scale_test_in.gpx -x kalman,profile=cycling,q_scale_vel=0.01 -o gpx -F ${TMPDIR}/kalman_q_scale_vel_low_filtered.gpx > ${TMPDIR}/kalman_q_scale_vel_low.log 2>&1
compare ${REFERENCE}/track/kalman_q_scale_vel_low_out.gpx ${TMPDIR}/kalman_q_scale_vel_low_filtered.gpx
cat ${TMPDIR}/kalman_q_scale_vel_low.log

# High q_scale_vel (less velocity smoothing)
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_q_scale_test_in.gpx -x kalman,profile=cycling,q_scale_vel=1.0 -o gpx -F ${TMPDIR}/kalman_q_scale_vel_high_filtered.gpx > ${TMPDIR}/kalman_q_scale_vel_high.log 2>&1
compare ${REFERENCE}/track/kalman_q_scale_vel_high_out.gpx ${TMPDIR}/kalman_q_scale_vel_high_filtered.gpx
cat ${TMPDIR}/kalman_q_scale_vel_high.log

# Test for interp_max_dt override
gpsbabel -i gpx -f ${REFERENCE}/track/kalman_interpolation_in.gpx -x kalman,profile=cycling,interp_max_dt=10 -o gpx -F ${TMPDIR}/kalman_interp_max_dt_override_filtered.gpx > ${TMPDIR}/kalman_interp_max_dt_override.log 2>&1
compare ${REFERENCE}/track/kalman_interp_max_dt_override_out.gpx ${TMPDIR}/kalman_interp_max_dt_override_filtered.gpx
cat ${TMPDIR}/kalman_interp_max_dt_override.log