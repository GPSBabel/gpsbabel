rm -f ${TMPDIR}/googletakeout.gpx
gpsbabel \
  -i googletakeout \
  -f ${REFERENCE}/googletakeout \
  -o gpx \
  -F ${TMPDIR}/googletakeout.gpx

if ! which xmllint > /dev/null
then
  echo "WARNING: xmllint not installed, skipping detailed googletakeout tests"
  return 0
fi

test_takeout_xpath() {
  local testname="$1"
  local xpath="$2"
  local expected="$3"
  echo -n "$testname: "
  result=$(
    "${BASEPATH}/tools/xml_slice" \
      "$xpath" \
      "${TMPDIR}/googletakeout.gpx" \
      "http://www.topografix.com/GPX/1/0" \
      | xargs
  ) 2> ${TMPDIR}/takeout.error
  if [ "$result" = "$expected" ]
  then
    echo "ok"
    return 0
  else
    echo "expected '$expected', got '$result'"
    cat ${TMPDIR}/takeout.error
    return 1
  fi
}

test_takeout_xpath 'Camped at Whirlpool Lake' \
  '/gpx/wpt[name="Whirlpool Lake Campground"][1]/time/text()' \
  '2013-06-18T22:02:16Z'
test_takeout_xpath 'Two days at Whirlpool Lake' \
  'count(/gpx/wpt[name="Whirlpool Lake Campground"])' \
  2
test_takeout_xpath 'The long drive to Whirlpool Lake' \
  'count(/gpx/trk/trkseg[trkpt[1]/time="2013-06-18T19:45:55.425Z"]/trkpt)' \
  4

